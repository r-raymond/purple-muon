<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">--  Copyright 2016, 2017 Robin Raymond</span><span>
</span><a name="line-2"></a><span class="hs-comment">--</span><span>
</span><a name="line-3"></a><span class="hs-comment">--  This file is part of Purple Muon</span><span>
</span><a name="line-4"></a><span class="hs-comment">--</span><span>
</span><a name="line-5"></a><span class="hs-comment">--  Purple Muon is free software: you can redistribute it and/or modify</span><span>
</span><a name="line-6"></a><span class="hs-comment">--  it under the terms of the GNU General Public License as published by</span><span>
</span><a name="line-7"></a><span class="hs-comment">--  the Free Software Foundation, either version 3 of the License, or</span><span>
</span><a name="line-8"></a><span class="hs-comment">--  (at your option) any later version.</span><span>
</span><a name="line-9"></a><span class="hs-comment">--</span><span>
</span><a name="line-10"></a><span class="hs-comment">--  Purple Muon is distributed in the hope that it will be useful,</span><span>
</span><a name="line-11"></a><span class="hs-comment">--  but WITHOUT ANY WARRANTY; without even the implied warranty of</span><span>
</span><a name="line-12"></a><span class="hs-comment">--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><span>
</span><a name="line-13"></a><span class="hs-comment">--  GNU General Public License for more details.</span><span>
</span><a name="line-14"></a><span class="hs-comment">--</span><span>
</span><a name="line-15"></a><span class="hs-comment">--  You should have received a copy of the GNU General Public License</span><span>
</span><a name="line-16"></a><span class="hs-comment">--  along with Purple Muon.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span><span>
</span><a name="line-17"></a><span>
</span><a name="line-18"></a><span class="hs-comment">{-|
Module      : Client.Video.Texture
Description : Texture handling utitlities.
Copyright   : (c) Robin Raymond, 2016
License     : GPL-3
Maintainer  : robin@robinraymond.de
Portability : POSIX

This module uses SDL2 and JuicyPixels to work with textures. JuicyPixels is used
to load arbitrary image formats. These are then converted to RGBA8 images which
SDL2 uses to upload to the video card.

All image files need to have an accompanying texture atlas file. This file needs
to satisfy the following criteria:

    * it needs to be a valid xml file
    * it has to consist of a single outer xml element which has the property
    `imagePath`, with value the path of the actual image file (specified from
    the root of the git repository)
    * the content of the single outer xml element has to be more xml elements,
    which have the following properties:

        * `name`: The name that is used to load this file
        * `x`: The `x` offset in the image specified by `imagePath`
        * `y`: The `y` offset in the image specified by `imagePath`
        * `width`: The width of the texture
        * `height`: The height of the texture

The names of the xml elements are arbitrary. Anything besides the above
mentioned will be ignored and can safely be used to encode additional
information.
-}</span><span>
</span><a name="line-50"></a><span>
</span><a name="line-51"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts      #-}</span><span>
</span><a name="line-52"></a><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><a name="line-53"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Video</span><span class="hs-operator">.</span><span class="hs-identifier">Texture</span><span>
</span><a name="line-54"></a><span>    </span><span class="hs-special">(</span><span> </span><a href="Client.Video.Texture.html#newTextureLoader"><span class="hs-identifier hs-var">newTextureLoader</span></a><span>
</span><a name="line-55"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Client.Video.Texture.html#renderTexture"><span class="hs-identifier hs-var">renderTexture</span></a><span>
</span><a name="line-56"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Client.Video.Texture.html#addTextureAtlas"><span class="hs-identifier hs-var">addTextureAtlas</span></a><span>
</span><a name="line-57"></a><span>    </span><span class="hs-special">,</span><span> </span><a href="Client.Video.Texture.html#getTexture"><span class="hs-identifier hs-var">getTexture</span></a><span>
</span><a name="line-58"></a><span>    </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Protolude</span><span>
</span><a name="line-61"></a><span>
</span><a name="line-62"></a><span class="hs-keyword">import</span><span>           </span><a href="Paths_purple_muon.html"><span class="hs-identifier">Paths_purple_muon</span></a><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Codec</span><span class="hs-operator">.</span><span class="hs-identifier">Picture</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CPI</span><span>
</span><a name="line-65"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">IntMap</span><span class="hs-operator">.</span><span class="hs-identifier">Strict</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DIS</span><span>
</span><a name="line-66"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span class="hs-operator">.</span><span class="hs-identifier">Storable</span><span>       </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">DVS</span><span>
</span><a name="line-67"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Foreign</span><span class="hs-operator">.</span><span class="hs-identifier">C</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>            </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">FCT</span><span>
</span><a name="line-68"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Linear</span><span class="hs-operator">.</span><span class="hs-identifier">Affine</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LAF</span><span>
</span><a name="line-69"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Linear</span><span class="hs-operator">.</span><span class="hs-identifier">V2</span><span>                  </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">LV2</span><span>
</span><a name="line-70"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">SDL</span><span>                        </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SDL</span><span>
</span><a name="line-71"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">SDL</span><span class="hs-operator">.</span><span class="hs-identifier">Vect</span><span>                   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SVE</span><span>
</span><a name="line-72"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">SDL</span><span class="hs-operator">.</span><span class="hs-identifier">Video</span><span class="hs-operator">.</span><span class="hs-identifier">Renderer</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">SVR</span><span>
</span><a name="line-73"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">XML</span><span class="hs-operator">.</span><span class="hs-identifier">Light</span><span>             </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TXL</span><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="Client.Video.Types.html"><span class="hs-identifier">Client</span><span class="hs-operator">.</span><span class="hs-identifier">Video</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">CVT</span><span>
</span><a name="line-76"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><a href="PurpleMuon.Util.MonadError.html"><span class="hs-identifier">PurpleMuon</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">MonadError</span></a><span> </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">PUM</span><span>
</span><a name="line-77"></a><span>
</span><a name="line-78"></a><span class="hs-comment">-- | Render a texture specified by a `CVT.TexUUID`.</span><span>
</span><a name="line-79"></a><span class="hs-identifier">renderTexture</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285811"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureLoader</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Client.Video.Types.html#TexUUID"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TexUUID</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Rectangle</span><span> </span><span class="hs-identifier hs-type">FCT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">CInt</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285811"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><a name="renderTexture"><a href="Client.Video.Texture.html#renderTexture"><span class="hs-identifier">renderTexture</span></a></a><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureLoader</span></a><span> </span><a name="local-6989586621679285812"><a href="#local-6989586621679285812"><span class="hs-identifier">at</span></a></a><span> </span><a name="local-6989586621679285813"><a href="#local-6989586621679285813"><span class="hs-identifier">te</span></a></a><span> </span><a name="local-6989586621679285814"><a href="#local-6989586621679285814"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TexUUID"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TexUUID</span></a><span> </span><a name="local-6989586621679285815"><a href="#local-6989586621679285815"><span class="hs-identifier">u</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679285816"><a href="#local-6989586621679285816"><span class="hs-identifier">mr</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-81"></a><span>    </span><span class="hs-keyword">case</span><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">lookup</span><span> </span><a href="#local-6989586621679285815"><span class="hs-identifier hs-var">u</span></a><span> </span><a href="#local-6989586621679285813"><span class="hs-identifier hs-var">te</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-82"></a><span>        </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>   </span><span class="hs-comment">-- render red square for missing</span><span>
</span><a name="line-83"></a><span>            </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">rendererDrawColor</span><span> </span><a href="#local-6989586621679285814"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-identifier hs-var">SDL</span><span class="hs-operator hs-var">.$=</span><span> </span><span class="hs-identifier hs-var">SVE</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">V4</span><span> </span><span class="hs-number">255</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-84"></a><span>            </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">fillRect</span><span> </span><a href="#local-6989586621679285814"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679285816"><span class="hs-identifier hs-var">mr</span></a><span>
</span><a name="line-85"></a><span>        </span><span class="hs-identifier hs-var">Just</span><span> </span><a name="local-6989586621679285978"><a href="#local-6989586621679285978"><span class="hs-identifier">t</span></a></a><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">copy</span><span> </span><a href="#local-6989586621679285814"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">CVT</span><span class="hs-operator">.</span><span class="hs-identifier">unTextureAtlas</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679285812"><span class="hs-identifier hs-var">at</span></a><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.!</span><span> </span><span class="hs-identifier">CVT</span><span class="hs-operator">.</span><span class="hs-identifier">atlas</span><span> </span><a href="#local-6989586621679285978"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>                              </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Just</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier">CVT</span><span class="hs-operator">.</span><span class="hs-identifier">rect</span><span> </span><a href="#local-6989586621679285978"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679285816"><span class="hs-identifier hs-var">mr</span></a><span>
</span><a name="line-87"></a><span>
</span><a name="line-88"></a><span>
</span><a name="line-89"></a><span class="hs-comment">-- |Find the `CVT.TexUUID` of a texture.</span><span>
</span><a name="line-90"></a><span class="hs-identifier">getTexture</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureLoader</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><a href="Client.Video.Types.html#TexUUID"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TexUUID</span></a><span>
</span><a name="line-91"></a><a name="getTexture"><a href="Client.Video.Texture.html#getTexture"><span class="hs-identifier">getTexture</span></a></a><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureLoader</span></a><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679285979"><a href="#local-6989586621679285979"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span>  </span><a name="local-6989586621679285980"><a href="#local-6989586621679285980"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-92"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TexUUID"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TexUUID</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fst</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-identifier">_</span><span class="hs-special">,</span><span> </span><a name="local-6989586621679285992"><a href="#local-6989586621679285992"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">CVT</span><span class="hs-operator">.</span><span class="hs-identifier">name</span><span> </span><a href="#local-6989586621679285992"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><a href="#local-6989586621679285980"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">assocs</span><span> </span><a href="#local-6989586621679285979"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span class="hs-comment">-- |Create a new texture loader.</span><span>
</span><a name="line-95"></a><span class="hs-identifier">newTextureLoader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Renderer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureLoader</span></a><span>
</span><a name="line-96"></a><a name="newTextureLoader"><a href="Client.Video.Texture.html#newTextureLoader"><span class="hs-identifier">newTextureLoader</span></a></a><span> </span><a name="local-6989586621679285993"><a href="#local-6989586621679285993"><span class="hs-identifier">r</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureLoader</span></a><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">empty</span><span> </span><a href="#local-6989586621679285993"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-number">0</span><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span class="hs-comment">-- |Add an texture atlas to a texture loader</span><span>
</span><a name="line-99"></a><span class="hs-identifier">addTextureAtlas</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285810"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285810"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-100"></a><span>                </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureLoader</span></a><span>
</span><a name="line-101"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-102"></a><span>                </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285810"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureLoader</span></a><span>
</span><a name="line-103"></a><a name="addTextureAtlas"><a href="Client.Video.Texture.html#addTextureAtlas"><span class="hs-identifier">addTextureAtlas</span></a></a><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureLoader</span></a><span> </span><a name="local-6989586621679285994"><a href="#local-6989586621679285994"><span class="hs-identifier">at</span></a></a><span> </span><a name="local-6989586621679285995"><a href="#local-6989586621679285995"><span class="hs-identifier">te</span></a></a><span> </span><a name="local-6989586621679285996"><a href="#local-6989586621679285996"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679285997"><a href="#local-6989586621679285997"><span class="hs-identifier">k</span></a></a><span class="hs-special">)</span><span> </span><a name="local-6989586621679285998"><a href="#local-6989586621679285998"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-104"></a><span>    </span><span class="hs-special">(</span><a name="local-6989586621679285999"><a href="#local-6989586621679285999"><span class="hs-identifier">newAt</span></a></a><span class="hs-special">,</span><span> </span><a name="local-6989586621679286000"><a href="#local-6989586621679286000"><span class="hs-identifier">newTex</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Client.Video.Texture.html#parseTextureAtlas"><span class="hs-identifier hs-var">parseTextureAtlas</span></a><span> </span><a href="#local-6989586621679285996"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679285997"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679285998"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-105"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679286001"><a href="#local-6989586621679286001"><span class="hs-identifier">newAtMap</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621679285997"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679285999"><span class="hs-identifier hs-var">newAt</span></a><span> </span><a href="#local-6989586621679285994"><span class="hs-identifier hs-var">at</span></a><span>
</span><a name="line-106"></a><span>        </span><span class="hs-comment">-- Assume a maximum of 1000 Textures per Atlas (TODO: Make this less</span><span>
</span><a name="line-107"></a><span>        </span><span class="hs-comment">-- dumb)</span><span>
</span><a name="line-108"></a><span>        </span><a name="local-6989586621679286002"><a href="#local-6989586621679286002"><span class="hs-identifier">newTeKeys</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-number">1000</span><span class="hs-operator hs-var">*</span><a href="#local-6989586621679285997"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">+</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-number">1</span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><a name="line-109"></a><span>        </span><a name="local-6989586621679286003"><a href="#local-6989586621679286003"><span class="hs-identifier">h1</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-identifier hs-var">DIS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">insert</span><span> </span><a href="#local-6989586621679286002"><span class="hs-identifier hs-var">newTeKeys</span></a><span>
</span><a name="line-110"></a><span>        </span><a name="local-6989586621679286004"><a href="#local-6989586621679286004"><span class="hs-identifier">h2</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">zip</span><span> </span><a href="#local-6989586621679286003"><span class="hs-identifier hs-var">h1</span></a><span> </span><a href="#local-6989586621679286000"><span class="hs-identifier hs-var">newTex</span></a><span>
</span><a name="line-111"></a><span>        </span><a name="local-6989586621679286005"><a href="#local-6989586621679286005"><span class="hs-identifier">h3</span></a></a><span>        </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><a name="local-6989586621679286007"><a href="#local-6989586621679286007"><span class="hs-identifier">x</span></a></a><span class="hs-special">,</span><a name="local-6989586621679286008"><a href="#local-6989586621679286008"><span class="hs-identifier">y</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679286007"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679286008"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679286004"><span class="hs-identifier hs-var">h2</span></a><span>
</span><a name="line-112"></a><span>        </span><a name="local-6989586621679286006"><a href="#local-6989586621679286006"><span class="hs-identifier">newTeMap</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">foldr</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679286009"><a href="#local-6989586621679286009"><span class="hs-identifier">x</span></a></a><span> </span><a name="local-6989586621679286010"><a href="#local-6989586621679286010"><span class="hs-identifier">y</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679286009"><span class="hs-identifier hs-var">x</span></a><span> </span><a href="#local-6989586621679286010"><span class="hs-identifier hs-var">y</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679285995"><span class="hs-identifier hs-var">te</span></a><span> </span><a href="#local-6989586621679286005"><span class="hs-identifier hs-var">h3</span></a><span>
</span><a name="line-113"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Client.Video.Types.html#TextureLoader"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureLoader</span></a><span> </span><a href="#local-6989586621679286001"><span class="hs-identifier hs-var">newAtMap</span></a><span> </span><a href="#local-6989586621679286006"><span class="hs-identifier hs-var">newTeMap</span></a><span> </span><a href="#local-6989586621679285996"><span class="hs-identifier hs-var">r</span></a><span> </span><span class="hs-special">(</span><a href="#local-6989586621679285997"><span class="hs-identifier hs-var">k</span></a><span class="hs-operator hs-var">+</span><span class="hs-number">1</span><span class="hs-special">)</span><span>
</span><a name="line-114"></a><span>
</span><a name="line-115"></a><span class="hs-comment">-- |Helper function for addTextureAtlas</span><span>
</span><a name="line-116"></a><span class="hs-identifier">parseTextureAtlas</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285809"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285809"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-117"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Renderer</span><span>
</span><a name="line-118"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Client.Video.Types.html#AtlasUUID"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">AtlasUUID</span></a><span>
</span><a name="line-119"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-120"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285809"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-special">(</span><a href="Client.Video.Types.html#TextureAtlas"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureAtlas</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><a href="Client.Video.Types.html#Texture"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Texture</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-121"></a><a name="parseTextureAtlas"><a href="Client.Video.Texture.html#parseTextureAtlas"><span class="hs-identifier">parseTextureAtlas</span></a></a><span> </span><a name="local-6989586621679286011"><a href="#local-6989586621679286011"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679286012"><a href="#local-6989586621679286012"><span class="hs-identifier">k</span></a></a><span> </span><a name="local-6989586621679286013"><a href="#local-6989586621679286013"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-122"></a><span>    </span><a name="local-6989586621679286014"><a href="#local-6989586621679286014"><span class="hs-identifier">xml</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Client.Video.Texture.html#loadTextureAtlas"><span class="hs-identifier hs-var">loadTextureAtlas</span></a><span> </span><a href="#local-6989586621679286013"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-123"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679286015"><a href="#local-6989586621679286015"><span class="hs-identifier">texs</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">filter</span><span> </span><a href="Client.Video.Texture.html#contentFilter"><span class="hs-identifier hs-var">contentFilter</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier">TXL</span><span class="hs-operator">.</span><span class="hs-identifier">elContent</span><span> </span><a href="#local-6989586621679286014"><span class="hs-identifier hs-var">xml</span></a><span class="hs-special">)</span><span>
</span><a name="line-124"></a><span>    </span><a name="local-6989586621679286016"><a href="#local-6989586621679286016"><span class="hs-identifier">header</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Client.Video.Texture.html#parseTextureAtlasHeader"><span class="hs-identifier hs-var">parseTextureAtlasHeader</span></a><span> </span><a href="#local-6989586621679286011"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679286014"><span class="hs-identifier hs-var">xml</span></a><span>
</span><a name="line-125"></a><span>    </span><a name="local-6989586621679286487"><a href="#local-6989586621679286487"><span class="hs-identifier">atts</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">sequence</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><a href="Client.Video.Texture.html#parseTexture"><span class="hs-identifier hs-var">parseTexture</span></a><span> </span><a href="#local-6989586621679286012"><span class="hs-identifier hs-var">k</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679286015"><span class="hs-identifier hs-var">texs</span></a><span class="hs-special">)</span><span>
</span><a name="line-126"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-special">(</span><a href="#local-6989586621679286016"><span class="hs-identifier hs-var">header</span></a><span class="hs-special">,</span><span> </span><a href="#local-6989586621679286487"><span class="hs-identifier hs-var">atts</span></a><span class="hs-special">)</span><span>
</span><a name="line-127"></a><span>
</span><a name="line-128"></a><span class="hs-identifier">contentFilter</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">TXL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Content</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Bool</span><span>
</span><a name="line-129"></a><a name="contentFilter"><a href="Client.Video.Texture.html#contentFilter"><span class="hs-identifier">contentFilter</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Elem</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">True</span><span>
</span><a name="line-130"></a><span class="hs-identifier">contentFilter</span><span> </span><span class="hs-identifier">_</span><span>            </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">False</span><span>
</span><a name="line-131"></a><span>
</span><a name="line-132"></a><span class="hs-comment">-- |Helper function for parseTextureAtlas</span><span>
</span><a name="line-133"></a><span class="hs-identifier">parseTextureAtlasHeader</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285808"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285808"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-134"></a><span>                        </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Renderer</span><span>
</span><a name="line-135"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TXL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Element</span><span>
</span><a name="line-136"></a><span>                        </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285808"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Client.Video.Types.html#TextureAtlas"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">TextureAtlas</span></a><span>
</span><a name="line-137"></a><a name="parseTextureAtlasHeader"><a href="Client.Video.Texture.html#parseTextureAtlasHeader"><span class="hs-identifier">parseTextureAtlasHeader</span></a></a><span> </span><a name="local-6989586621679286488"><a href="#local-6989586621679286488"><span class="hs-identifier">r</span></a></a><span> </span><a name="local-6989586621679286489"><a href="#local-6989586621679286489"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-138"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679286490"><a href="#local-6989586621679286490"><span class="hs-identifier">atts</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">TXL</span><span class="hs-operator">.</span><span class="hs-identifier">elAttribs</span><span> </span><a href="#local-6989586621679286489"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-139"></a><span>    </span><a name="local-6989586621679286491"><a href="#local-6989586621679286491"><span class="hs-identifier">path</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="PurpleMuon.Util.MonadError.html#liftMaybe"><span class="hs-identifier hs-var">PUM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">liftMaybe</span></a><span> </span><span class="hs-string">&quot;Error parsing Texture atlas header&quot;</span><span> </span><span class="hs-special">(</span><a href="Client.Video.Texture.html#xmlAttrHelper"><span class="hs-identifier hs-var">xmlAttrHelper</span></a><span> </span><a href="#local-6989586621679286490"><span class="hs-identifier hs-var">atts</span></a><span> </span><span class="hs-string">&quot;imagePath&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-140"></a><span>    </span><a name="local-6989586621679286492"><a href="#local-6989586621679286492"><span class="hs-identifier">surf</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Client.Video.Texture.html#loadSurface"><span class="hs-identifier hs-var">loadSurface</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621679286491"><span class="hs-identifier hs-var">path</span></a><span class="hs-special">)</span><span>
</span><a name="line-141"></a><span>    </span><a name="local-6989586621679286493"><a href="#local-6989586621679286493"><span class="hs-identifier">tex</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="Client.Video.Texture.html#surfaceToTexture"><span class="hs-identifier hs-var">surfaceToTexture</span></a><span> </span><a href="#local-6989586621679286488"><span class="hs-identifier hs-var">r</span></a><span> </span><a href="#local-6989586621679286492"><span class="hs-identifier hs-var">surf</span></a><span>
</span><a name="line-142"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Client.Video.Types.html#TextureAtlas"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">TextureAtlas</span></a><span> </span><a href="#local-6989586621679286493"><span class="hs-identifier hs-var">tex</span></a><span>
</span><a name="line-143"></a><span>
</span><a name="line-144"></a><span>
</span><a name="line-145"></a><span class="hs-identifier">xmlAttrHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-identifier hs-type">TXL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Attr</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Maybe</span><span> </span><span class="hs-identifier hs-type">Text</span><span>
</span><a name="line-146"></a><a name="xmlAttrHelper"><a href="Client.Video.Texture.html#xmlAttrHelper"><span class="hs-identifier">xmlAttrHelper</span></a></a><span> </span><a name="local-6989586621679286494"><a href="#local-6989586621679286494"><span class="hs-identifier">atts</span></a></a><span> </span><a name="local-6989586621679286495"><a href="#local-6989586621679286495"><span class="hs-identifier">key</span></a></a><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-147"></a><span>    </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">TXL</span><span class="hs-operator">.</span><span class="hs-identifier">attrVal</span><span class="hs-special">)</span><span>
</span><a name="line-148"></a><span>         </span><span class="hs-special">(</span><span class="hs-identifier hs-var">find</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679286496"><a href="#local-6989586621679286496"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">TXL</span><span class="hs-operator">.</span><span class="hs-identifier">attrKey</span><span> </span><a href="#local-6989586621679286496"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">==</span><span> </span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">QName</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621679286495"><span class="hs-identifier hs-var">key</span></a><span class="hs-special">)</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679286494"><span class="hs-identifier hs-var">atts</span></a><span class="hs-special">)</span><span>
</span><a name="line-149"></a><span>
</span><a name="line-150"></a><span class="hs-identifier">parseTexture</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285807"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="Client.Video.Types.html#AtlasUUID"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">AtlasUUID</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">TXL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Content</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285807"><span class="hs-identifier hs-type">m</span></a><span> </span><a href="Client.Video.Types.html#Texture"><span class="hs-identifier hs-type">CVT</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Texture</span></a><span>
</span><a name="line-151"></a><a name="parseTexture"><a href="Client.Video.Texture.html#parseTexture"><span class="hs-identifier">parseTexture</span></a></a><span> </span><a name="local-6989586621679286497"><a href="#local-6989586621679286497"><span class="hs-identifier">k</span></a></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Elem</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Element</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">QName</span><span> </span><span class="hs-string">&quot;SubTexture&quot;</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span> </span><span class="hs-identifier hs-var">Nothing</span><span class="hs-special">)</span><span> </span><a name="local-6989586621679286498"><a href="#local-6989586621679286498"><span class="hs-identifier">attr</span></a></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-identifier">_</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-152"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679286499"><a href="#local-6989586621679286499"><span class="hs-identifier">liftHelper</span></a></a><span> </span><a name="local-6989586621679286501"><a href="#local-6989586621679286501"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PurpleMuon.Util.MonadError.html#liftMaybe"><span class="hs-identifier hs-var">PUM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">liftMaybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error parsing attribute &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679286501"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Client.Video.Texture.html#xmlAttrHelper"><span class="hs-identifier hs-var">xmlAttrHelper</span></a><span> </span><a href="#local-6989586621679286498"><span class="hs-identifier hs-var">attr</span></a><span> </span><a href="#local-6989586621679286501"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-153"></a><span>        </span><a name="local-6989586621679286500"><a href="#local-6989586621679286500"><span class="hs-identifier">parseHelper</span></a></a><span> </span><a name="local-6989586621679286502"><a href="#local-6989586621679286502"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="PurpleMuon.Util.MonadError.html#liftMaybe"><span class="hs-identifier hs-var">PUM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">liftMaybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error parsing attribute &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><a href="#local-6989586621679286502"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readMaybe</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621679286502"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-154"></a><span>    </span><a name="local-6989586621679286521"><a href="#local-6989586621679286521"><span class="hs-identifier">name</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286499"><span class="hs-identifier hs-var">liftHelper</span></a><span> </span><span class="hs-string">&quot;name&quot;</span><span>
</span><a name="line-155"></a><span>    </span><a name="local-6989586621679286522"><a href="#local-6989586621679286522"><span class="hs-identifier">x</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286499"><span class="hs-identifier hs-var">liftHelper</span></a><span> </span><span class="hs-string">&quot;x&quot;</span><span>
</span><a name="line-156"></a><span>    </span><a name="local-6989586621679286523"><a href="#local-6989586621679286523"><span class="hs-identifier">y</span></a></a><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286499"><span class="hs-identifier hs-var">liftHelper</span></a><span> </span><span class="hs-string">&quot;y&quot;</span><span>
</span><a name="line-157"></a><span>    </span><a name="local-6989586621679286524"><a href="#local-6989586621679286524"><span class="hs-identifier">width</span></a></a><span>  </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286499"><span class="hs-identifier hs-var">liftHelper</span></a><span> </span><span class="hs-string">&quot;width&quot;</span><span>
</span><a name="line-158"></a><span>    </span><a name="local-6989586621679286525"><a href="#local-6989586621679286525"><span class="hs-identifier">height</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286499"><span class="hs-identifier hs-var">liftHelper</span></a><span> </span><span class="hs-string">&quot;height&quot;</span><span>
</span><a name="line-159"></a><span>    </span><a name="local-6989586621679286526"><a href="#local-6989586621679286526"><span class="hs-identifier">xInt</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286500"><span class="hs-identifier hs-var">parseHelper</span></a><span> </span><a href="#local-6989586621679286522"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-160"></a><span>    </span><a name="local-6989586621679286527"><a href="#local-6989586621679286527"><span class="hs-identifier">yInt</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286500"><span class="hs-identifier hs-var">parseHelper</span></a><span> </span><a href="#local-6989586621679286523"><span class="hs-identifier hs-var">y</span></a><span>
</span><a name="line-161"></a><span>    </span><a name="local-6989586621679286528"><a href="#local-6989586621679286528"><span class="hs-identifier">wInt</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286500"><span class="hs-identifier hs-var">parseHelper</span></a><span> </span><a href="#local-6989586621679286524"><span class="hs-identifier hs-var">width</span></a><span>
</span><a name="line-162"></a><span>    </span><a name="local-6989586621679286529"><a href="#local-6989586621679286529"><span class="hs-identifier">hInt</span></a></a><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><a href="#local-6989586621679286500"><span class="hs-identifier hs-var">parseHelper</span></a><span> </span><a href="#local-6989586621679286525"><span class="hs-identifier hs-var">height</span></a><span>
</span><a name="line-163"></a><span>    </span><span class="hs-identifier hs-var">return</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Client.Video.Types.html#Texture"><span class="hs-identifier hs-var">CVT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Texture</span></a><span> </span><a href="#local-6989586621679286497"><span class="hs-identifier hs-var">k</span></a><span> </span><a href="#local-6989586621679286521"><span class="hs-identifier hs-var">name</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">Rectangle</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LAF</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">P</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">LV2</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">V2</span><span> </span><a href="#local-6989586621679286526"><span class="hs-identifier hs-var">xInt</span></a><span> </span><a href="#local-6989586621679286527"><span class="hs-identifier hs-var">yInt</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LV2</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">V2</span><span> </span><a href="#local-6989586621679286528"><span class="hs-identifier hs-var">wInt</span></a><span> </span><a href="#local-6989586621679286529"><span class="hs-identifier hs-var">hInt</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span class="hs-identifier">parseTexture</span><span> </span><span class="hs-identifier">_</span><span> </span><a name="local-6989586621679286530"><a href="#local-6989586621679286530"><span class="hs-identifier">t</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">throwError</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error parsing texture&quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">show</span><span> </span><a href="#local-6989586621679286530"><span class="hs-identifier hs-var">t</span></a><span class="hs-special">)</span><span>
</span><a name="line-165"></a><span>
</span><a name="line-166"></a><span class="hs-identifier">loadTextureAtlas</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285046"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285046"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span>                  </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span>
</span><a name="line-168"></a><span>                  </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285046"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">TXL</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Element</span><span>
</span><a name="line-169"></a><a name="loadTextureAtlas"><a href="Client.Video.Texture.html#loadTextureAtlas"><span class="hs-identifier">loadTextureAtlas</span></a></a><span> </span><a name="local-6989586621679286531"><a href="#local-6989586621679286531"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-170"></a><span>    </span><a name="local-6989586621679286595"><a href="#local-6989586621679286595"><span class="hs-identifier">c</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">readFile</span><span> </span><a href="#local-6989586621679286531"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-171"></a><span>    </span><a href="PurpleMuon.Util.MonadError.html#liftMaybe"><span class="hs-identifier hs-var">PUM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">liftMaybe</span></a><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;Error parsing &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621679286531"><span class="hs-identifier hs-var">p</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">TXL</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">parseXMLDoc</span><span> </span><a href="#local-6989586621679286595"><span class="hs-identifier hs-var">c</span></a><span class="hs-special">)</span><span>
</span><a name="line-172"></a><span>
</span><a name="line-173"></a><span class="hs-identifier">surfaceToTexture</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285045"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Renderer</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Surface</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285045"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Texture</span><span>
</span><a name="line-174"></a><a name="surfaceToTexture"><a href="Client.Video.Texture.html#surfaceToTexture"><span class="hs-identifier">surfaceToTexture</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">createTextureFromSurface</span><span>
</span><a name="line-175"></a><span>
</span><a name="line-176"></a><span class="hs-identifier">loadSurface</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MonadError</span><span> </span><span class="hs-identifier hs-type">Text</span><span> </span><a href="#local-6989586621679285044"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285044"><span class="hs-identifier hs-type">m</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">FilePath</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285044"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Surface</span><span>
</span><a name="line-177"></a><a name="loadSurface"><a href="Client.Video.Texture.html#loadSurface"><span class="hs-identifier">loadSurface</span></a></a><span> </span><a name="local-6989586621679286613"><a href="#local-6989586621679286613"><span class="hs-identifier">p</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-178"></a><span>    </span><a name="local-6989586621679286614"><a href="#local-6989586621679286614"><span class="hs-identifier">realPath</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Paths_purple_muon.html#getDataFileName"><span class="hs-identifier hs-var">getDataFileName</span></a><span> </span><a href="#local-6989586621679286613"><span class="hs-identifier hs-var">p</span></a><span>
</span><a name="line-179"></a><span>    </span><a name="local-6989586621679286615"><a href="#local-6989586621679286615"><span class="hs-identifier">mImg</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">CPI</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">readImage</span><span> </span><a href="#local-6989586621679286614"><span class="hs-identifier hs-var">realPath</span></a><span>
</span><a name="line-180"></a><span>    </span><a name="local-6989586621679286617"><a href="#local-6989586621679286617"><span class="hs-identifier">img</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><a href="PurpleMuon.Util.MonadError.html#liftEitherWith"><span class="hs-identifier hs-var">PUM</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">liftEitherWith</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><a name="local-6989586621679286616"><a href="#local-6989586621679286616"><span class="hs-identifier">err</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-string">&quot;Could not load image: &quot;</span><span> </span><span class="hs-operator hs-var">&lt;&gt;</span><span> </span><span class="hs-identifier hs-var">toS</span><span> </span><a href="#local-6989586621679286616"><span class="hs-identifier hs-var">err</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679286615"><span class="hs-identifier hs-var">mImg</span></a><span>
</span><a name="line-181"></a><span>    </span><a href="Client.Video.Texture.html#loadSurfaceHelper"><span class="hs-identifier hs-var">loadSurfaceHelper</span></a><span> </span><a href="#local-6989586621679286617"><span class="hs-identifier hs-var">img</span></a><span>
</span><a name="line-182"></a><span>
</span><a name="line-183"></a><span class="hs-identifier">loadSurfaceHelper</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">MonadIO</span><span> </span><a href="#local-6989586621679285043"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">CPI</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">DynamicImage</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-6989586621679285043"><span class="hs-identifier hs-type">m</span></a><span> </span><span class="hs-identifier hs-type">SVR</span><span class="hs-operator hs-type">.</span><span class="hs-identifier hs-type">Surface</span><span>
</span><a name="line-184"></a><a name="loadSurfaceHelper"><a href="Client.Video.Texture.html#loadSurfaceHelper"><span class="hs-identifier">loadSurfaceHelper</span></a></a><span> </span><a name="local-6989586621679286618"><a href="#local-6989586621679286618"><span class="hs-identifier">img</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><a name="line-185"></a><span>    </span><span class="hs-keyword">let</span><span> </span><a name="local-6989586621679286619"><a href="#local-6989586621679286619"><span class="hs-identifier">rgba8</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">CPI</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">convertRGBA8</span><span> </span><a href="#local-6989586621679286618"><span class="hs-identifier hs-var">img</span></a><span>
</span><a name="line-186"></a><span>        </span><a name="local-6989586621679286620"><a href="#local-6989586621679286620"><span class="hs-identifier">width</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CPI</span><span class="hs-operator">.</span><span class="hs-identifier">imageWidth</span><span> </span><a href="#local-6989586621679286619"><span class="hs-identifier hs-var">rgba8</span></a><span>
</span><a name="line-187"></a><span>        </span><a name="local-6989586621679286621"><a href="#local-6989586621679286621"><span class="hs-identifier">height</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CPI</span><span class="hs-operator">.</span><span class="hs-identifier">imageWidth</span><span> </span><a href="#local-6989586621679286619"><span class="hs-identifier hs-var">rgba8</span></a><span>
</span><a name="line-188"></a><span>        </span><a name="local-6989586621679286622"><a href="#local-6989586621679286622"><span class="hs-identifier">dim</span></a></a><span>    </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">fmap</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">FCT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">CInt</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">LV2</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">V2</span><span> </span><a href="#local-6989586621679286620"><span class="hs-identifier hs-var">width</span></a><span> </span><a href="#local-6989586621679286621"><span class="hs-identifier hs-var">height</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span>        </span><a name="local-6989586621679286623"><a href="#local-6989586621679286623"><span class="hs-identifier">pitch</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">FCT</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">CInt</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">fromIntegral</span><span> </span><span class="hs-special">(</span><span class="hs-number">4</span><span> </span><span class="hs-operator hs-var">*</span><span> </span><a href="#local-6989586621679286620"><span class="hs-identifier hs-var">width</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span>        </span><a name="local-6989586621679286624"><a href="#local-6989586621679286624"><span class="hs-identifier">iData</span></a></a><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">CPI</span><span class="hs-operator">.</span><span class="hs-identifier">imageData</span><span> </span><a href="#local-6989586621679286619"><span class="hs-identifier hs-var">rgba8</span></a><span>
</span><a name="line-191"></a><span>        </span><a name="local-6989586621679286625"><a href="#local-6989586621679286625"><span class="hs-identifier">cmask</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">ABGR8888</span><span>
</span><a name="line-192"></a><span>    </span><a name="local-6989586621679286626"><a href="#local-6989586621679286626"><span class="hs-identifier">rawData</span></a></a><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-identifier hs-var">liftIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">stToIO</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><span class="hs-identifier hs-var">DVS</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">thaw</span><span> </span><a href="#local-6989586621679286624"><span class="hs-identifier hs-var">iData</span></a><span>
</span><a name="line-193"></a><span>    </span><span class="hs-identifier hs-var">SVR</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">createRGBSurfaceFrom</span><span> </span><a href="#local-6989586621679286626"><span class="hs-identifier hs-var">rawData</span></a><span> </span><a href="#local-6989586621679286622"><span class="hs-identifier hs-var">dim</span></a><span> </span><a href="#local-6989586621679286623"><span class="hs-identifier hs-var">pitch</span></a><span> </span><a href="#local-6989586621679286625"><span class="hs-identifier hs-var">cmask</span></a><span>
</span><a name="line-194"></a><span>
</span><a name="line-195"></a></pre></body></html>